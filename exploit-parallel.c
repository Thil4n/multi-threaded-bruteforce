#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <sys/time.h>
#include <pthread.h>
#include <math.h>

#define PASSWORD_LEN 8

void *bruteforce(void *thread_index);

int found = 0;
int num_threads = 1;
int total_tries = 0;

int main(int argc, char *argv[])
{
    if (argc > 1)
    {
        num_threads = atoi(argv[1]);
    }

    struct timeval start_time, end_time;

    gettimeofday(&start_time, NULL);

    pthread_t threads[num_threads];
    int rc;
    long t;
    for (t = 0; t < num_threads; t++)
    {
        rc = pthread_create(&threads[t], NULL, bruteforce, (void *)t);
        if (rc)
        {
            printf("ERROR; return code from pthread_create() is %d\n", rc);
            exit(-1);
        }
    }

    for (t = 0; t < num_threads; t++)
    {
        pthread_join(threads[t], NULL);
    }

    gettimeofday(&end_time, NULL);

    if (!found)
    {
        printf("Password not found.\n");
    }

    double elapsed_time = (end_time.tv_sec - start_time.tv_sec) + (end_time.tv_usec - start_time.tv_usec) / 1e6;
    double tries_per_second = total_tries / elapsed_time;

    printf("Time taken: %.6f seconds\n", elapsed_time);
    printf("Estimated tries per second: %.6f\n", tries_per_second);

    return 0;
}

void *bruteforce(void *thread_index)
{
    int total = pow(10, PASSWORD_LEN);

    int amount_per_thread = total / num_threads;
    int start = ((long)thread_index) * amount_per_thread;
    int end = ((long)thread_index + 1) * amount_per_thread;

    printf("Thread %ld trying range: %d-%d\n", thread_index, start, end);

    char password[7];

    for (int i = start; i <= end && !found; i++)
    {
        total_tries++;

        sprintf(password, "%05d", i);

        pid_t pid = fork();

        if (pid == -1)
        {
            perror("fork");
            pthread_exit(NULL);
        }
        else if (pid == 0)
        {
            char *args[] = {"./prog", password, NULL};
            execv(args[0], args);

            perror("execv");
            exit(1);
        }
        else
        {
            int status;
            waitpid(pid, &status, 0);

            if (WIFEXITED(status) && WEXITSTATUS(status) == 0)
            {
                printf("Password found: %s\n", password);
                found = 1;
                break;
            }
        }
    }

    pthread_exit(NULL);
}